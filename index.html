
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Commander Threat Counter v1.1</title>

<style>
body{
  margin:0;
  background:#0c1118;
  font-family:-apple-system, BlinkMacSystemFont, sans-serif;
  color:white;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  grid-template-rows:1fr 1fr;
  height:100vh;
  gap:6px;
  padding:6px;
}

.player{
  background:#141c27;
  border-radius:16px;
  padding:8px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  position:relative;
  transition:all .2s ease;
  border:1px solid rgba(255,255,255,.08);
}

.player.threat{
  box-shadow:0 0 20px #baff2a88, 0 0 40px #ffe94a66;
  border:2px solid #baff2a;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.name{
  font-weight:700;
  font-size:14px;
  cursor:pointer;
}

select{
  background:#1e293b;
  border:none;
  color:white;
  padding:3px 5px;
  border-radius:6px;
  font-size:12px;
}

.life{
  text-align:center;
  font-size:52px;
  font-weight:900;
  cursor:pointer;
}

.controls{
  display:flex;
  justify-content:space-between;
}

button{
  flex:1;
  margin:2px;
  border:none;
  border-radius:10px;
  padding:8px 0;
  font-size:18px;
  font-weight:700;
  background:#1f2a3a;
  color:white;
}

.stats{
  font-size:11px;
}

.statRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.smallBtn{
  font-size:12px;
  padding:3px 6px;
  margin-left:2px;
  border-radius:6px;
}

.cmdBtn{
  margin-top:4px;
  font-size:11px;
  padding:6px 0;
  background:#223046;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
}

.modalContent{
  background:#1b2533;
  padding:16px;
  border-radius:12px;
  width:90%;
  max-width:350px;
}

.modalRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:8px 0;
}
</style>
</head>

<body>
<div class="grid" id="grid"></div>

<div class="modal" id="cmdModal">
  <div class="modalContent" id="cmdContent"></div>
</div>

<script>
const START = { life:40, cards:7, permanents:0, mana:0, poison:0 };

let players = [];
let heat = [0,0,0,0];
let lastThreat = null;

function createPlayer(index){
  return {
    id:index,
    name:"Seat "+(index+1),
    archetype:"Aggro",
    life:START.life,
    cards:START.cards,
    permanents:START.permanents,
    mana:START.mana,
    poison:START.poison,
    cmd:[0,0,0,0]
  };
}

for(let i=0;i<4;i++){
  players.push(createPlayer(i));
}

function computeThreat(){

  let avgLife = players.reduce((a,p)=>a+p.life,0)/4;
  let avgCards = players.reduce((a,p)=>a+p.cards,0)/4;
  let avgMana = players.reduce((a,p)=>a+p.mana,0)/4;
  let avgPerm = players.reduce((a,p)=>a+p.permanents,0)/4;

  const wL=0.20, wC=1.0, wM=1.3, wP=0.8;
  const alpha=0.75, gamma=0.25;

  const speedAxis = {
    Aggro:1.0,
    Combo:1.2,
    Midrange:0.5,
    Control:0.0
  };

  let archetypeCounts={Aggro:0,Combo:0,Midrange:0,Control:0};
  players.forEach(p=>archetypeCounts[p.archetype]++);

  let scores=[];

  players.forEach((p,i)=>{

    let dL = p.life-avgLife;
    let dC = p.cards-avgCards;
    let dM = p.mana-avgMana;
    let dP = p.permanents-avgPerm;

    let URS = wL*dL + wC*dC + wM*dM + wP*dP;

    let LD = p.life/40;
    let PD = (10-p.poison)/10;
    let CD = 1;

    for(let j=0;j<4;j++){
      if(j!==i){
        CD=Math.min(CD,(21-p.cmd[j])/21);
      }
    }

    let ES = Math.min(LD,PD,CD);
    let TCI = 1-ES;

    let base = alpha*URS + gamma*TCI;

    let nT = archetypeCounts[p.archetype];
    let minorityFactor = 1 - 0.18*((3-nT)/3);

    let seatIndex=i;
    let seatMultiplier = 1 + 0.08*speedAxis[p.archetype]*((3-seatIndex)/3);

    let infoBonus=1;
    if(p.archetype==="Control"){
      infoBonus = 1 + 0.05*(seatIndex/3);
    }

    let score = base*minorityFactor*seatMultiplier*infoBonus*(1-heat[i]);

    scores.push(score);
  });

  let max=Math.max(...scores);
  let newThreat=scores.indexOf(max);

  if(lastThreat!==null){
    if(scores[newThreat] < scores[lastThreat]*1.08){
      newThreat=lastThreat;
    }
  }

  players.forEach((p,i)=>{
    if(i===newThreat){
      heat[i]=Math.min(.35,heat[i]+.03);
    }else{
      heat[i]=Math.max(0,heat[i]-.02);
    }
  });

  lastThreat=newThreat;
  players.forEach((p,i)=>p.isThreat=(i===newThreat));
}

function render(){
  computeThreat();
  const grid=document.getElementById("grid");
  grid.innerHTML="";

  players.forEach((p,i)=>{

    let div=document.createElement("div");
    div.className="player"+(p.isThreat?" threat":"");

    div.innerHTML=`
    <div class="header">
      <div class="name" onclick="editName(${i})">${p.name}</div>
      <select onchange="setArch(${i},this.value)">
        <option ${p.archetype==="Aggro"?"selected":""}>Aggro</option>
        <option ${p.archetype==="Combo"?"selected":""}>Combo</option>
        <option ${p.archetype==="Midrange"?"selected":""}>Midrange</option>
        <option ${p.archetype==="Control"?"selected":""}>Control</option>
      </select>
    </div>

    <div class="life" onclick="setLife(${i})">${p.life}</div>

    <div class="controls">
      <button onclick="adjust(${i},-1)">-</button>
      <button onclick="adjust(${i},1)">+</button>
    </div>

    <div class="stats">
      ${statRow(i,"Cards","cards")}
      ${statRow(i,"Mana","mana")}
      ${statRow(i,"Perm","permanents")}
      ${statRow(i,"Poison","poison")}
    </div>

    <button class="cmdBtn" onclick="openCmd(${i})">Commander Damage</button>
    `;

    grid.appendChild(div);
  });
}

function statRow(i,label,stat){
  return `
  <div class="statRow">
    ${label}: ${players[i][stat]}
    <span>
      <button class="smallBtn" onclick="statAdjust(${i},'${stat}',-1)">-</button>
      <button class="smallBtn" onclick="statAdjust(${i},'${stat}',1)">+</button>
    </span>
  </div>`;
}

function openCmd(i){
  let modal=document.getElementById("cmdModal");
  let content=document.getElementById("cmdContent");
  content.innerHTML="<h3>Commander Damage Taken</h3>";

  players.forEach((p,j)=>{
    if(j!==i){
      content.innerHTML+=`
      <div class="modalRow">
        From Seat ${j+1}: ${players[i].cmd[j]}
        <span>
          <button class="smallBtn" onclick="cmdAdjust(${i},${j},-1)">-</button>
          <button class="smallBtn" onclick="cmdAdjust(${i},${j},1)">+</button>
        </span>
      </div>`;
    }
  });

  content.innerHTML+=`<button onclick="closeCmd()">Close</button>`;
  modal.style.display="flex";
}

function closeCmd(){
  document.getElementById("cmdModal").style.display="none";
  render();
}

function cmdAdjust(i,j,val){
  players[i].cmd[j]=Math.max(0,Math.min(21,players[i].cmd[j]+val));
  openCmd(i);
}

function adjust(i,val){ players[i].life+=val; render(); }
function statAdjust(i,stat,val){ players[i][stat]=Math.max(0,players[i][stat]+val); render(); }
function editName(i){ let n=prompt("Name:",players[i].name); if(n) players[i].name=n; render(); }
function setLife(i){ let v=prompt("Life:",players[i].life); if(!isNaN(v)) players[i].life=parseInt(v); render(); }
function setArch(i,val){ players[i].archetype=val; render(); }

render();
</script>
</body>
</html>
